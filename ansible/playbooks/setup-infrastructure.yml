- name: Setup Kubernetes Infrastructure
  hosts: local
  become: yes
  tasks:
    - name: Check if K3s is installed
      stat:
        path: /usr/local/bin/k3s
      register: k3s_binary

    - name: Install K3s
      shell: curl -sfL https://get.k3s.io | sh -s - --write-kubeconfig-mode 644
      when: not k3s_binary.stat.exists

    - name: Wait for K3s to be ready
      wait_for:
        path: /etc/rancher/k3s/k3s.yaml
        timeout: 60
      when: not k3s_binary.stat.exists